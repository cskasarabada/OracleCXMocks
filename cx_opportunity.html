<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Argano Opportunity</title>
<link rel="stylesheet" href="assets/redwood.css"/>
<script defer src="assets/app.js"></script>
</head>
<body class="oppty-landing">
<header class="miconnex-bar">
  <div class="logo-mark">
    <span class="logo-icon argano">A</span>
    <div>
      <div class="logo-text">Argano</div>
      <div class="logo-sub">Connected Cloud</div>
    </div>
  </div>
  <div class="bar-actions">
    <button class="ghost-btn small">Help</button>
    <button class="ghost-btn small">Support</button>
    <div class="avatar-chip">CK</div>
  </div>
</header>
<nav class="quick-nav auto-nav">
  <div class="nav-group">
    <div class="nav-label">Sales &amp; Delivery Journey</div>
    <div class="nav-items">
      <a href="index.html">Overview</a>
      <a href="Easy_Start_Flows.html">Easy Start</a>
      <a href="sales_cloud.html">Sales Flow</a>
      <a href="sales_tools.html">Sales Tools</a>
      <a href="cx_lead.html">Lead</a>
      <a href="cx_opportunity.html" class="active">Opportunity</a>
      <a href="ppm_pursuit.html">PPM Pursuit</a>
      <a href="ppm_construction.html">PPM Construction</a>
      <a href="quick_sales_screen.html" class="accent">Quick Sales Screen</a>
    </div>
  </div>
  <div class="nav-group">
    <div class="nav-label">Insights &amp; Toolkit</div>
    <div class="nav-items">
      <a href="analytics.html">Analytics</a>
      <a href="forecasting_pipeline.html">Forecasting</a>
      <a href="integration_features.html">Integration</a>
      <a href="sales_process_visualization.html">Process Visualization</a>
      <a href="results_driven.html">Results Driven</a>
      <a href="executive_command_center.html">Exec Command</a>
      <a href="account_360.html">Account 360</a>
      <a href="partner_hub.html">Partner Hub</a>
      <a href="revenue_intelligence.html">Revenue Intelligence</a>
      <a href="field_mobile_snapshot.html">Field Mobile</a>
      <a href="sales_ppm_sync.html">Sales-PPM</a>
      <a href="quote_to_docusign.html">Quote to DocuSign</a>
      <a href="pursuit_project.html">Pursuit Project</a>
    </div>
  </div>
</nav>
<main class="oppty-shell">
  <section class="smart-banner" id="oppty-smart-banner">
    <div>
      <p class="eyebrow">Smart Actions</p>
      <h3>Coach every opportunity conversation</h3>
      <p>Trigger approvals, next steps, and partner engagement for <strong id="oppty-smart-name">this opportunity</strong>.</p>
    </div>
    <div class="actions">
      <div class="pill-row">
        <button type="button" class="btn" data-oppty-action="Log Call">Log Call</button>
        <button type="button" class="btn" data-oppty-action="Send Quote">Send Quote</button>
        <button type="button" class="btn" data-oppty-action="Request Approval">Request Approval</button>
        <button type="button" class="btn" data-oppty-action="Launch DocuSign">Launch DocuSign</button>
      </div>
      <div class="action-block">
        <label class="visually-hidden" for="oppty-smart-select">Smart Actions</label>
        <select id="oppty-smart-select">
          <option value="">- Select Smart Action -</option>
          <option value="Log Call">Log Call</option>
          <option value="Send Quote">Send Quote</option>
          <option value="Request Approval">Request Approval</option>
          <option value="Launch DocuSign">Launch DocuSign</option>
          <option value="Create Pursuit">Create Pursuit</option>
          <option value="Escalate">Escalate</option>
        </select>
        <button type="button" class="btn" id="oppty-smart-apply">Apply</button>
      </div>
    </div>
  </section>
  <div class="crumbs">
    <div class="crumb-label">My Open Opportunities</div>
    <div class="crumb-actions">
      <button class="ghost-icon" aria-label="Previous opportunity">&larr;</button>
      <button class="ghost-icon" aria-label="Next opportunity">&rarr;</button>
      <button class="btn outline">Details</button>
    </div>
  </div>

  <section class="opps-preview-card">
    <div class="card-header">
      <div>
        <h3>My Open Opportunities</h3>
        <div class="card-sub">Try searching by keyword or add a filter</div>
      </div>
      <span class="results-count" id="opps-count-label">Results</span>
    </div>
    <div id="opps-preview" class="table-shell"></div>
  </section>

  <section class="oppty-hero-slim">
    <div class="oppty-header-row">
      <div>
        <h1 id="opptyHeroTitle">TT1 eea</h1>
        <div class="hero-sub" id="opptyHeroSub">Account &bull; Primary Contact</div>
      </div>
      <div class="hero-actions">
        <button class="ghost-icon">Share</button>
        <button class="ghost-icon">Sync</button>
        <button class="ghost-icon">Email</button>
        <button class="btn primary">Details</button>
      </div>
    </div>
    <div class="oppty-stage-buttons">
      <div class="stage hero-stage">
        <span class="s cur" data-v="Qualification">Statement of Qualification</span>
        <span class="s" data-v="Evaluation">Evaluation</span>
        <span class="s" data-v="Proposal">Proposal</span>
        <span class="s" data-v="Negotiation">Negotiation</span>
        <span class="s" data-v="Closed Won">Closed Won</span>
      </div>
    </div>
    <div class="oppty-info-strip">
      <span>Status Open</span>
      <span>Win Probability 40%</span>
      <span>Account Warner Design Associates Inc.</span>
      <span>Owner Chandra Kasarabada</span>
      <span>Opportunity #42048</span>
    </div>
    <div class="hero-cta" style="margin-top:14px">
      <button class="btn brand" id="add-new-oppty-btn">Create Opportunity</button>
    </div>
  </section>

  <section class="oppty-board">
    <div class="oppty-board-grid">
      <article class="oppty-board-card">
        <h3>Contacts</h3>
        <p>There are no contacts added for this opportunity yet.</p>
        <p class="muted">As contacts are added, you can view them here.</p>
      </article>
      <article class="oppty-board-card">
        <h3>Team</h3>
        <div class="team-card">
          <div class="avatar">CK</div>
          <div>
            <div class="team-name">Chandra Kasarabada</div>
            <div class="team-email">chandra.Kasarabada@argano.com</div>
            <span class="team-chip">Owner</span>
          </div>
        </div>
        <a class="panel-link" href="#">View All Team Members (1)</a>
      </article>
      <article class="oppty-board-card">
        <h3>Project</h3>
        <p>Keep the commercial team aligned with project delivery.</p>
        <button class="btn brand" id="btnCreatePursuit" type="button">Navigate to PPM</button>
        <div class="project-progress">
          <div class="status-pill" id="status">Idle</div>
          <div class="progress"><div class="bar" id="prog"></div></div>
        </div>
      </article>
      <article class="oppty-board-card">
        <h3>Partners</h3>
        <p>There are no partners assigned for this opportunity yet.</p>
        <p class="muted">As partners are assigned, you can view them here.</p>
      </article>
      <article class="oppty-board-card">
        <h3>Competitors</h3>
        <p>There are no competitors identified yet.</p>
        <p class="muted">As competitors are identified, you can view them here and track their threat levels.</p>
      </article>
    </div>
  </section>

  <div class="carousel-dots" role="presentation">
    <span class="dot active"></span>
    <span class="dot"></span>
    <span class="dot"></span>
    <span class="dot"></span>
    <span class="dot"></span>
  </div>

  <div class="sr-only">
    <div class="timeline" id="opptyTl"></div>
  </div>

  <form id="oppForm" class="sr-only">
    <input name="name" id="opptyName"/>
    <input name="amount" id="opptyAmount" type="number"/>
    <input type="hidden" name="stage" id="stageVal" value="Qualification"/>
  </form>

</main>

<nav class="app-nav-rail"><div class="app-nav-items"></div></nav>

<div id="add-oppty-modal" class="qs-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:120" aria-hidden="true">
  <div class="qs-modal lead-modal" role="dialog" aria-modal="true" aria-labelledby="addOpptyTitle" tabindex="-1" style="width:min(760px,94%)">
    <h2 id="addOpptyTitle">Create Opportunity</h2>
    <form id="addOpptyForm">
      <div class="field"><label>Name</label><input name="name" required></div>
      <div class="field"><label>Account</label><input name="account"></div>
      <div class="two-col">
        <div class="field" style="grid-template-columns:1fr"><label>Amount</label><input name="amount" type="number"></div>
        <div class="field" style="grid-template-columns:1fr"><label>Owner</label><input name="owner"></div>
      </div>
      <div class="field"><label>Stage</label><select name="stage"><option>Qualification</option><option>Evaluation</option><option>Proposal</option><option>Negotiation</option><option>Closed Won</option></select></div>
      <div class="field"><label>Notes</label><textarea name="notes" rows="3"></textarea></div>
      <div class="actions">
        <button type="button" class="btn" onclick="closeAddOppty()">Cancel</button>
        <button type="submit" class="btn primary">Save Opportunity</button>
      </div>
    </form>
  </div>
</div>

<script>
window.addEventListener('DOMContentLoaded', function(){
  var fallbackState = { oppty:{ activities:[] }, lead:{}, opportunities:[] };
  var hasRWD = !!(window.RWD && typeof window.RWD.get==='function');
  function safeSnapshot(){
    if(!hasRWD) return JSON.parse(JSON.stringify(fallbackState));
    try{
      var snap = RWD.get() || fallbackState;
      snap.oppty = snap.oppty || { activities:[] };
      snap.oppty.activities = snap.oppty.activities || [];
      snap.lead = snap.lead || {};
      snap.opportunities = snap.opportunities || [];
      return snap;
    }catch(err){
      console.warn('RWD.get failed', err);
      return JSON.parse(JSON.stringify(fallbackState));
    }
  }
  var state=safeSnapshot();
  var tl=document.getElementById('opptyTl');
  var stageField=document.getElementById('stageVal');
  function setStage(v){
    if(stageField) stageField.value=v;
    Array.prototype.slice.call(document.querySelectorAll('.stage .s')).forEach(function(sp){ sp.classList.toggle('cur', sp.dataset.v===v); });
  }
  function updateHero(snapshot){
    var data=snapshot||state||fallbackState;
    data.oppty = data.oppty || {};
    data.lead = data.lead || {};
    var nameField=document.getElementById('opptyName');
    if(nameField) nameField.value=data.oppty.name||'';
    var amtField=document.getElementById('opptyAmount');
    if(amtField) amtField.value=data.oppty.amount||0;
    try{
      var hero = document.getElementById('opptyHeroTitle');
      if(hero) hero.textContent = data.oppty.name || 'Sample Opportunity';
      var sub = document.getElementById('opptyHeroSub');
      if(sub) sub.textContent = (data.oppty.account || data.oppty.company || data.lead.company || 'Account') + ' \u2022 ' + (data.lead.contact || 'Primary Contact');
      var smart=document.getElementById('oppty-smart-name');
      if(smart) smart.textContent = data.oppty.name || 'this opportunity';
    }catch(e){}
    setStage(data.oppty.stage||'Qualification');
  }
  function renderTimeline(snapshot){
    var data=snapshot||state||fallbackState;
    if(!tl) return;
    tl.innerHTML='';
    (data.oppty && data.oppty.activities || []).forEach(function(a){
      var div=document.createElement('div');
      div.className='item';
      div.innerHTML='<div class="t">'+a.ts+'</div><div><div class="who">'+a.type+'</div><div class="what">'+a.text+'</div></div>';
      tl.appendChild(div);
    });
  }
  Array.prototype.slice.call(document.querySelectorAll('.stage .s')).forEach(function(sp){ sp.addEventListener('click', function(){ setStage(sp.dataset.v); }); });
  var pursuitBtn=document.getElementById('btnCreatePursuit');
  if(pursuitBtn){
    pursuitBtn.addEventListener('click', function(){
      var payload=formToObject(document.getElementById('oppForm'));
      persistOpportunity(payload);
      var statusEl=document.getElementById('status');
      var progEl=document.getElementById('prog');
      if(statusEl) statusEl.textContent='Running OIC job...';
      if(progEl) progEl.style.width='60%';
      var finish=function(){
        if(statusEl) statusEl.textContent='Completed';
        if(progEl) progEl.style.width='100%';
        setTimeout(function(){ try{ window.location='ppm_pursuit.html'; }catch(e){} }, 600);
      };
      if(window.RWD && typeof RWD.createPursuitViaOIC==='function'){
        try{ RWD.createPursuitViaOIC(finish); }catch(err){ console.error('createPursuitViaOIC failed', err); finish(); }
      }else{
        setTimeout(finish, 400);
      }
    });
  }
  updateHero(state);
  renderTimeline(state);
  initOpptySmartBanner();
  if(window.RWD && typeof RWD.subscribe==='function'){
    try{
      RWD.subscribe(function(snapshot){
        state=snapshot||safeSnapshot();
        updateHero(state);
        renderTimeline(state);
        try{ renderOppsPreview(); }catch(e){}
      });
    }catch(err){
      console.warn('RWD.subscribe failed', err);
    }
  }else if(hasRWD){
    setInterval(function(){
      var fresh=safeSnapshot();
      if((fresh.oppty.activities||[]).length !== (state.oppty.activities||[]).length){
        state=fresh;
        renderTimeline(state);
      }
    }, 800);
  }
  try{ renderOppsPreview(); }catch(e){}
});
// Add New Opportunity modal handlers
function openAddOppty(){
  var m = document.getElementById('add-oppty-modal');
  if(window.ModalManager && typeof ModalManager.showModal==='function'){
    try{ ModalManager.showModal('add-oppty-modal'); document.body.classList.add('modal-visible'); return; }catch(e){}
  }
  if(m){
    m.style.display='flex';
    m.setAttribute('aria-hidden','false');
    document.body.classList.add('modal-visible');
    var f = m.querySelector('input[name="name"]'); if(f) f.focus();
  }
}
function closeAddOppty(){
  var m=document.getElementById('add-oppty-modal');
  if(window.ModalManager && typeof ModalManager.closeModal==='function'){
    try{ ModalManager.closeModal('add-oppty-modal'); }catch(e){}
  }
  if(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); }
  document.body.classList.remove('modal-visible');
}

document.addEventListener('DOMContentLoaded', function(){
  var btn = document.getElementById('add-new-oppty-btn'); if(btn) btn.addEventListener('click', openAddOppty);
  var form = document.getElementById('addOpptyForm'); if(form){ form.addEventListener('submit', function(ev){ ev.preventDefault(); try{ var obj=formToObject(form); persistOpportunity(obj); }catch(e){ console.error('save oppty failed', e); if(typeof showToast==='function') showToast('Save failed'); }
      closeAddOppty(); try{ renderOppsPreview(); }catch(e){}
  }); }
  // initial preview render
  try{ renderOppsPreview(); }catch(e){}
});

function persistOpportunity(obj){
  var saved=false;
  if(window.RWD && typeof RWD.saveOppty==='function'){
    try{ RWD.saveOppty(obj); saved=true; }catch(e){ console.error('RWD.saveOppty failed', e); }
  } else if(window.RWD && typeof RWD.get==='function' && typeof RWD.set==='function'){
    try{
      var s = RWD.get() || {};
      s.opportunities = s.opportunities || [];
      s.opportunities.unshift(obj);
      s.oppty = s.oppty || {};
      s.oppty.activities = s.oppty.activities || [];
      s.oppty.activities.unshift({ ts:new Date().toLocaleString(), type:'Create', text: 'Opportunity created: ' + (obj.name || obj.account || '') });
      RWD.set(s);
      saved=true;
    }catch(err){ console.warn('Fallback RWD.set failed', err); }
  } else {
    window.__demoFallbackOpps = window.__demoFallbackOpps || [];
    window.__demoFallbackOpps.unshift(obj);
    saved=true;
  }
  if(saved){
    if(typeof showToast==='function') showToast('Opportunity saved'); else alert('Opportunity saved');
  } else {
    console.warn('Opportunity not persisted (demo services unavailable)');
  }
}

function formToObject(form){
  var obj={};
  if(!form) return obj;
  try{
    var fd=new FormData(form);
    fd.forEach(function(v,k){ obj[k]=v; });
  }catch(e){
    console.warn('FormData unavailable, attempting manual serialization', e);
    var elements = form.elements || [];
    Array.prototype.forEach.call(elements, function(el){ if(el.name) obj[el.name]=el.value; });
  }
  return obj;
}

// Render recent opportunities preview
function renderOppsPreview(){
  var container = document.getElementById('opps-preview'); if(!container) return;
  var s = (window.RWD && typeof RWD.get==='function')?RWD.get():null;
  var opps = (s && s.opportunities) ? s.opportunities : (window.__demoFallbackOpps || []);
  var total = opps ? opps.length : 0;
  var countLabel = document.getElementById('opps-count-label'); if(countLabel) countLabel.textContent = total + ' Results';
  if(!opps || opps.length===0){ container.innerHTML = '<div style="color:var(--rw-muted)">No opportunities yet. Click "Create Opportunity" to add one.</div>'; return; }
  var html='<table class="table" style="width:100%"><thead><tr><th>Name</th><th>Account</th><th>Amount</th><th>Stage</th><th style="width:110px">Actions</th></tr></thead><tbody>';
  opps.slice(0,20).forEach(function(o,idx){
    var acct=escapeHtml(o.account || o.company || '');
    html += '<tr><td>'+escapeHtml(o.name||'')+'</td><td>'+acct+'</td><td>'+formatCurrency(o.amount)+'</td><td>'+escapeHtml(o.stage||'')+'</td><td><button class="btn" onclick="prefillAddOppty('+idx+')">Import</button></td></tr>';
  });
  html += '</tbody></table>'; container.innerHTML = html;
}

function prefillAddOppty(index){
  var s = (window.RWD && typeof RWD.get==='function')?RWD.get():null;
  var opps = (s && s.opportunities)?s.opportunities:(window.__demoFallbackOpps || []);
  if(!opps || opps.length===0) return;
  var opp = opps[index] || opps[0];
  var form = document.getElementById('addOpptyForm'); if(!form) return;
  Object.keys(opp).forEach(function(k){ try{ if(form.elements[k]) form.elements[k].value = opp[k]; }catch(e){} });
  if(form.elements.account && !form.elements.account.value && opp.company){ form.elements.account.value = opp.company; }
  openAddOppty();
}

function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

function saveOppDraft(){ if(typeof showToast==='function') showToast('Draft saved (demo)'); }
function cancelOppDraft(){ if(typeof showToast==='function') showToast('Draft canceled'); }
function formatCurrency(val){ var num=Number(val); return num?('$'+num.toLocaleString()):''; }

function initOpptySmartBanner(){
  var buttons=document.querySelectorAll('[data-oppty-action]');
  buttons.forEach(function(btn){
    btn.addEventListener('click', function(){ fireOpptyAction(btn.dataset.opptyAction || btn.textContent); });
  });
  var select=document.getElementById('oppty-smart-select');
  var apply=document.getElementById('oppty-smart-apply');
  if(apply){
    apply.addEventListener('click', function(){ if(select) fireOpptyAction(select.value); });
  }
}

function fireOpptyAction(action){
  if(!action) return;
  if(window.RWD && typeof RWD.actOppty==='function'){
    RWD.actOppty(action);
  }
  if(typeof showToast==='function') showToast(action+' triggered');
}
</script>
<div class="footer">Copyright Demo - Redwood-inspired mockup</div>
</body>
</html>
